<include file="Index:nav-cur" />

<div class="col-xs-12">
<form class="form-horizontal form-pda form-scan" action="__SELF__" method="POST">
  <input type="hidden" name="t" value="login" />
  <div class="row-fluid">
  <div class="col-xs-12">
  <div class="form-group">
  <div class="input-group">
      <span class="input-group-addon">
      <i class="glyphicon glyphicon-pencil"></i>
    	</span>
      <input autocomplete="off" value="" type="text" class="form-control input-lg input-pda" id="code" name="code" placeholder="请输入订单号或手机后4位">
    </div>
  </div>
 </div>
 <div class="clearfix"></div>
 </div>
 <br/>

</form>
</div>

<div class="col-xs-12" id="orders">
<volist name="data" id="vo">

<neq name="i" value="1">
<neq name="vo['user_id']" value="$user_id">
<gt name="j" value="0"></div></gt>
{~$j = 0 ;}
</neq>
</neq>

<neq name="vo['user_id']" value="$user_id">
<div class="panel panel-default">
  <div class="list-group-item list-group-item-inf">
    <h4 class="list-group-item-heading">
      <a data-lat="{$vo.geo.lat}" data-lng="{$vo.geo.lng}" class="navigation-map">{$vo.deliver_addr} {$vo.shop_name}
      <i class="  glyphicon glyphicon-send"></i></a>
    </h4>
    <hr/>
    <i class="glyphicon glyphicon-user"></i> {$vo.realname}  &nbsp;&nbsp;
    <i class="glyphicon glyphicon-phone"></i> <a href="tel:{$vo.mobile}">{$vo.mobile} <i class="glyphicon glyphicon-earphone"></i></a> 
    {$vo.pay_status} 
  </div>
  <notempty name="vo['remarks']">
  <div class="panel-footer"><i class="glyphicon glyphicon-comment"></i> {$vo.remarks}</div>
  </notempty>
</neq>

<switch name="vo['status_cn']" >
<case value="已签收" break="0"></case>
<case value="已完成" break="0"></case>
<case value="已回款" break="1">
  <a class="list-group-item list-group-item-success" data-toggle="collapse" data-target="#info_{$vo.id}" aria-expanded="true" aria-controls="info_{$vo.id}">
  </case>
<case value="已退货" break="1">
  <a class="list-group-item list-group-item-danger collapsed" data-toggle="collapse" data-target="#info_{$vo.id}" aria-expanded="true" aria-controls="info_{$vo.id}">
  </case>
<default />
<a class="list-group-item  panel-footer collapsed" data-toggle="collapse" data-target="#info_{$vo.id}" aria-expanded="false" data-parent="#orders" aria-controls="info_{$vo.id}">
</switch>
订单 {$vo.id} {$vo.order_type_cn}&nbsp;
  <i class="glyphicon glyphicon-list-alt"></i> {:count($vo['detail'])} 行
    <i class="glyphicon glyphicon-th-large"></i> {$vo.quantity} 件 
    <i class="glyphicon glyphicon-yen"></i> {$vo.final_price} 元 

点击展开
<switch name="vo['status_cn']" >
<case value="已签收" break="0"></case>
<case value="已完成" break="0"></case>
<case value="已回款" break="1">
  <label class="label label-success">{$vo.status_cn}</label>
  </case>
<case value="已退货" break="1">
 <label class="label label-danger">{$vo.status_cn}</label>
</case>
<default />
</switch>
</a>
  <div class="panel-collapse collapse" aria-expanded="true"  id="info_{$vo.id}">
  <form class="order">
    <input type="hidden" name="id" value="{$vo.id}" />
    <ul class="list-group" >
    <li class="list-group-item">状态：{$vo.status_cn}</li>

    <!--
      <li class="list-group-item">线路：{$vo.city_name}{$vo.site_name} {$vo.line}</li>
      <li class="list-group-item">配送：{$vo.deliver_date} {$vo.deliver_time}</li>
      <li class="list-group-item">销售：AM：{$vo.am.name} {$vo.am.mobile}</li>

      <li class="list-group-item">销售：BD：{$vo.bd.name} {$vo.bd.mobile}</li>
          
    
    </ul>
</div>



<div class="panel panel-default">
  <div class="panel-heading">
      <a class="collapsed" data-toggle="collapse" data-target="#detail_{$vo.id}" aria-expanded="true" aria-controls="detail_{$vo.id}">
            商品列表 (点击展开)
          </a>
  </div>
  <div class="panel-collapse collapse" id="detail_{$vo.id}">

    <ul class="list-group" >  -->
  <volist name="vo['detail']" id="v">
  <li class="list-group-item">
    {$v.sku_number} {$v.name} <foreach name="v['spec']" item="spec">{$spec['name']}:{$spec['val']};</foreach>
  </li>
  <li class="list-group-item">
    <div class="input-group row">
    <input type="hidden" name="pro_id[]" value="{$v.id}" />
    <!--
      <input type="hidden" name="price_unit[]" value="{$v.price}" />
    -->
      <input type="hidden" name="price_unit[]" value="{$v.single_price}" />
      <span class="input-group-addon">¥ {$v.single_price}/{$v.close_unit}</span>
       
      <input type="number" name="quantity[]" min="0" class="form-control" placeholder="{$v.quantity}" value="{$v.quantity}">
      <span class="input-group-addon">{$v.unit_id}</span>
      <input type="number" name="price_sum[]" min="0" class="form-control" placeholder="{$v.sum_price}" value="{$v.sum_price}">
      <span class="input-group-addon">元</span>
    </div>
  </li>
  </volist>

</ul>
    <div class="panel-footer">
      <div class="input-group row">
            <span class="input-group-addon">下单金额</span>
          <input type="text" class="form-control" placeholder="{$vo.total_price}" value="{$vo.total_price}" readonly>

            <span class="input-group-addon">优惠金额</span>
          <input type="text" class="form-control" placeholder="" value="{$vo.minus_amount}" readonly>
        </div>
        <div class="input-group row">
            <span class="input-group-addon">应收金额</span>
        <input type="text" class="form-control" placeholder="{$vo.final_price}" value="{$vo.final_price}" readonly>

            <span class="input-group-addon">实收金额</span>
        <input type="text" name="deal_price" class="form-control" placeholder="" value="{$vo.deal_price}">
        </div>
    </div>
<switch name="vo['status_cn']" >
<case value="已签收" break="0"></case>
<case value="已完成" break="0"></case>
<case value="已回款" break="1"></case>
<case value="已退货" break="0"></case>
<case value="已出库" break="0"></case>
<case value="待收货" break="0">

    <div class="panel-footer">
      <div class="col-xs-6">
          <a class="btn-reject btn btn-danger btn-block">拒收</a>
      </div>
      <div class="col-xs-6">
          <a class="btn-sign btn btn-success btn-block">签收</a>
      </div>
      <div class="clearfix"></div>
    </div>

</case>
</switch>
<div class="panel-footer">
      <input class="form-control" type="text" name="sign_msg" value="{$vo.sign_msg}" placeholder="签收或退货备注">
    </div>


    </form>
</div>

<eq name="i" value="1">
{~$user_id = $vo['user_id']}
<else/>

</eq>
<neq name="vo['user_id']" value="$user_id">
</div>
<else/>
{~$j++;}
</neq>
  {~$user_id = $vo['user_id']}
</volist>

</div>


<style type="text/css">
hr{
  margin-top: 10px;
  margin-bottom: 10px;
}
form.order ul.list-group{
  margin-bottom: 0px;
}

</style>

<script type="text/javascript">

  function goToGaodeMap(lat,lng){
    if(typeof HostApp == "undefined") {
      alert('not in app.');
    }
    else {
      HostApp.toast(lat+','+lng);
      HostApp.navigationToMap(lat,lng);
    }
  }
  $(function(){
    $('.navigation-map').on('click',function(){
        var lat = $(this).data('lat');
        var lng = $(this).data('lng');
        if(lat == null || lat == '' || lng == null || lng == ''){
          return;
        }
        else {
          goToGaodeMap(lat,lng);
        }
    });
    $('#code').on('input', function(){
      //待完成，全局搜索;
    });

    $('.btn-sign').on('click',function(){
        var params = $(this).closest('form.order').serialize();
        var addr = "{:U('sign')}";
        
        $.ajax({
          url:addr,
          type:'post',
          cache : false,
          dataType:'json',
          data:params,
          success: function(msg){
            if(msg.status=='0'){
              alert(msg.msg); 
              location.reload();
            }
            else{
              alert_error(msg.msg); 
            }
          }
        });
    });

    $('.btn-reject').on('click',function(){
        var params = $(this).closest('form.order').serialize();
        var addr = "{:U('reject')}";
        
        $.ajax({
          url:addr,
          type:'post',
          cache : false,
          dataType:'json',
          data:params,
          success: function(msg){
            if(msg.status=='0'){
              alert(msg.msg); 
              location.reload();
            }
            else{
              alert_error(msg.msg); 
            }
          }
        });
    });
  });

</script>