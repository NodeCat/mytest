
<div class="table-responsive" >
  <form action="__SELF__" method="POST" class="form-inline" id="task-form">      
    <table class="table table-bordered">
          <tr class="text-center">
            <td colspan="4">
              <div class="task-head row col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <h2 class="text-center col-lg-4 col-md-4 col-md-offset-4 col-lg-offset-4">新建派车任务</h2>
                <a class='btn btn-success col-lg-1 col-md-1 col-lg-offset-1 col-md-offset-1' onclick="copyTask(this)">复制</a>
                <a class='btn btn-primary col-lg-1 col-md-1 col-lg-offset-1 col-md-offset-1' onclick="subForm()" >提交</a>
              </div>
            </td>
          </tr>
          <tr>
            <td colspan="4">
              <div class="form-group col-lg-12 col-md-12 col-sm-12 col-xs-12">
                  <label style="line-height:2.2" for="" class="control-label col-lg-2 col-md-2 col-sm-2 col-xs-2">任务名称(10字以内)
                    <span class="text-danger">*</span>&nbsp;
                  </label>
                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
                  <input type="text" name="task_name[]" class="form-control require" style="width:100%;" placeholder="输入任务名称">
                </div>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="form-group">
                <label for="" class="control-label">仓库
                  <span class="text-danger">*</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                </label>
                <select autocomplete="off" class="form-control require"  id="warehouse" name="wh_id[]" data-val="">
                  <option value="">选择仓库</option>
                  <volist name='warehouses' id='vo'>
                  <option value="{$vo.id}">{$vo.name}</option>
                  </volist>
                </select>
              </div>
            </td>
            <td>
              <div class="form-group">
                <label for="" class="control-label">任务类型
                  <span class="text-danger">*</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                </label>
                <select autocomplete="off" class="form-control require"  id="task_type" name="task_type[]" data-val="">
                  <option value="">选择状态</option>
                  <volist name='task_types' id='vo'>
                  <option value="{$vo.id}">{$vo.name}</option>
                  </volist>
                </select>
              </div>
            </td> 
            <td>
              <div class="form-group">
                <label for="" class="control-label">用车申请人
                  <span class="text-danger">*</span>&nbsp;
                </label>
                <input type="txt" name="apply_user[]" class="form-control require" placeholder="用车申请人" maxlength="4">
              </div>
            </td> 
            <td>
              <div class="form-group">
                <label for="" class="control-label">申请人联系方式
                  <span class="text-danger">*</span>&nbsp;
                </label>
                <input type="txt" name="apply_mobile[]" class="form-control require" placeholder="申请人联系方式" maxlength="18">
              </div>
            </td> 
          </tr>
          <tr>
            <td>
              <div class="form-group">
                <label for="" class="control-label">用车部门
                  <span class="text-danger">*</span>&nbsp;
                </label>
                <input type="txt" name="apply_department[]" class="form-control require" placeholder="用车部门">
              </div>
            </td>
            <td>
              <div class="form-group">
                <label for="" class="control-label">期望用车时间
                  <span class="text-danger">*</span>&nbsp;
                </label>
                <input type="txt" rel="datepicker" name="op_time[]" value="" class="form-control input-md form_datetime require" data-date-format="yyyy-mm-dd" placeholder="选择日期">
              </div>
            </td>
            <td>
              <div class="form-group">
                <label for="" class="control-label">期望车型
                  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                </label>
                <select autocomplete="off" class="form-control"  id="expect_car_type" name="expect_car_type[]" data-val="">
                  <option value="">选择车型</option>
                  <volist name='car_types' id='vo'>
                  <option value="{$vo.id}">{$vo.name}</option>
                  </volist>
                </select>
              </div>
            </td>
            <td>
              <div class="form-group">
                <label for="" class="control-label">预计运费(元)
                  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                </label>
                <input type="txt" name="expect_fee[]" class="form-control" placeholder="自动计算" readonly>
              </div>
            </td>
          </tr>
          <tr>
            <td colspan="3">
              <div class="form-group col-lg-12 col-md-12 col-sm-12 col-xs-12">
                  <label style="line-height:2.2" for="" class="control-label col-lg-2 col-md-2 col-sm-2 col-xs-2">用车事由</label>
                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
                  <input type="text" name="reason[]" class="form-control" style="width:100%;" placeholder="用车事由">
                </div>
              </div>
            </td>
            <td>
              <div class="form-group">
                <label for="" class="control-label">备注(长期/临时)
                    &nbsp;&nbsp;&nbsp;
                </label>
                <select autocomplete="off" class="form-control"  id="remark" name="remark[]" data-val="">
                  <option value="0">选择备注</option>
                  <option value="长期">长期</option>
                  <option value="临时">临时</option>
                </select>
              </div>
            </td>
          </tr>
          <tr>
            <td colspan="4">
              <div class="form-group">
                <label for="" class="control-label">选择记录点:</label>
                <input type="txt" class="form-control start-node" name="node[]" placeholder="选择起始任务点">&nbsp;&nbsp;
                <div class="form-group normal-node open" style="position:relative; margin-right:10px;margin-top:5px;">
                  <input type="txt" class="form-control" name="node[]" placeholder="选择记录点">
                  <a class="btn btn-xs btn-danger" style="position:absolute;top:-5px;right:-5px;" onclick="removeNode(this)"><span class="glyphicon glyphicon-remove" ></span></a>
                    <ul class="dropdown-menu hidden" style="margin-top:-1px;">
                    </ul>
                </div>
                <input type="txt" class="form-control end-node" name="node[]" placeholder="选择结束任务点">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <a href="javascript:void(0);" class="btn btn-primary" onclick="addNode(this)">+任务点</a>
              </div>
            </td>
            <div id="task-node" class="hidden">
              <div class="form-group normal-node" style="position:relative; margin-right:10px;margin-top:5px;">
                  <input type="txt" class="form-control" name="node[]" placeholder="选择记录点">
                  <a class="btn btn-xs btn-danger" style="position:absolute;top:-5px;right:-5px;" onclick="removeNode(this)"><span class="glyphicon glyphicon-remove" ></span></a>
                </div>
            </div>
          </tr>
          <tr>
            <td colspan="4">
              注：①申请最长期限为一个月，超出时限需重新申请；②申请用车3天（含）以上为长期申请
            </td>
          </tr>
      </table>
    </form>
    </div>

<script type="text/javascript">
    $('select').change(function(){
      var val = $(this).val();
      $(this).attr('data-val',val);
    })
    //表单验证提交
    function subForm(){
      var require = $(".require"),
          flag = 1;

      require.each(function(){
        var va = $(this).val();
        if(!va){
          flag = 0;
          alert('请将必选项填写完整');
          $(this).focus();
          return false;
        }
      })
      if(flag === 0){
        return false;
      }
      var form = $("#task-form").serialize();
      addr = "{:U('addTask')}";
      $.ajax({
        url:addr,
        type:'post',
        data:form,
        dataType:'json',
        cache:false,
        success:function(res){
          if(res.status == 0){
            location.href = "{:U('index')}";
          }else{
            alert(res.msg);
          }
        }
      })
    }
    //复制任务
    function copyTask(obj){
      var cancleBtn = "<a class='btn btn-danger col-lg-1 col-md-1 col-lg-offset-1 col-md-offset-1' onclick='delTask(this)'>移除</a>";
      var task = $(obj).parents('table').clone();
      task.find('.task-head a').remove();
      task.find('.task-head').append(cancleBtn);
      task.find('select').each(function(){
        var val = $(this).data('val');
        $(this).find("option[value="+val+"]").attr('selected',true);
      })
      $('#task-form').append(task);

    }
    //移除任务
    function delTask(obj){
      $(obj).parents('table').remove();
    }
    //添加任务点
    function addNode(obj){
      var node = $('#task-node').html();
      $(obj).siblings('.end-node').before(node);
    }
    //移除任务点
    function removeNode(obj){
      $(obj).parent('.normal-node').remove();
    }
    $('.normal-node').find('input').each(function(){
      var _this = $(this);
      _this.on('input',function(){
        var param = {keyword:_this.val()};
        $.ajax({
          url:"{:U('getCustomerList')}",
          type:'get',
          dataType:'json',
          data:param,
          success:function(res){
            var info = '';
            for(var c in res){
              info += '<li><a href="javascript:void(0);">'+res[c].shop_name+'，<span class="text-info">'+res[c].name+' ('+res[c].mobile+') </span></a></li>';
            }
            _this.siblings('ul').append(info).removeClass('hidden');
          }
        })
      })
    })
</script>

