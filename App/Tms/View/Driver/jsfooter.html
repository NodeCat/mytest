<script type="text/javascript">
  var action = "__ACTION__";
  //签收刷新后跳到之前的订单打印位置 
    var oid = "{$oid}";
    if(parseInt(oid) > 0) {
        $("a[data-oid="+oid+"]").trigger('click');
        $('#info_'+oid+'').addClass('in');
        location.href = action + "/id/{$id}/oid/"+oid+"#p_" + oid;
    }
    //打印小票
    function ticketPrint(printStr, oid, url, bid, pagecount){
      if(typeof HostApp == "undefined") {
        alert('使用打印功能请您先下载大厨网配送app.');
      }
      else {
        if(!HostApp.isBondPrinter()) {
          HostApp.toast('请先去个人中心绑定打印机型号.');
          return;
        }
        if(!printStr) {
            HostApp.toast('打印内容不能为空');
            return;
        }
        HostApp.printTicket(printStr,oid, url, bid, pagecount);
      }
    }

    function goToGaodeMap(lat, lng) {
      if (typeof HostApp == "undefined") {
        alert('使用导航功能请您先下载大厨网配送app.');
      } else {
        if (lat == null || lat == "''" || lng == null || lng == "''") {
          HostApp.toast('无法导航，销售没有录入该客户地址的坐标。');
          return;
        }
        HostApp.navigationToMap(lat, lng);
      }
    }
    $(function() {
      $('input[type=number]').on('click',function(){
        $(this).select();
      });

      $('#btn-clear').on('click',
      function() {
        $('#code').val('');
        $('#orders .panel').show();
      });
      $('.navigation-map').on('click',
      function() {
        var lat = $(this).data('lat');
        var lng = $(this).data('lng');
        goToGaodeMap(lat, lng);

      });
      $('#code').on('input',
      function() {
        var search = $(this).val();
        $('.order-id').each(function() {
          if ($(this).text().indexOf(search) == -1) {
            $(this).parents('.panel').hide();

          } else {
            $(this).parents('.panel').show();
          }
        })
      });

        $('.p_qty').on('input',function(){
          if($(this).siblings('.p_wgt').length == 0) {
            var obj = $(this);
            var qty = obj.val();
            var price_unit = obj.parent().find('.p_price').val();
            obj.parent().find('.p_sum').text(accMul(qty , price_unit));//计算当前行的小计
            inputChange($(this));
          }
        });
        $('.p_wgt').on('input',function(){
          var obj = $(this);
          var qty = obj.val();
          var price_unit = obj.parent().find('.p_price').val();
          obj.parent().find('.p_sum').text(accMul(qty , price_unit));//计算当前行的小计
          inputChange($(this));
        });
        $('.p_deposit').on('input',function(){
          inputChange($(this));
        });
        function inputChange(obj){
          var final_price = 0;
          var line_qty = 0;
          var line_wgt = 0;
          var line_wgt_obj;
          var line_price = 0;
          //计算这张订单的应收金额，累加数量＊单价
          obj.parents('.order').find('.p_qty').each(function(index,item){
            line_price = $(item).parent().find('.p_price').val();
            line_wgt_obj = $(item).siblings('.p_wgt');
            line_qty = $(item).val();
            if(line_wgt_obj.length > 0){
              var line_wgt = line_wgt_obj.val(); 
              line_qty = (line_wgt == 0) ? line_qty : line_wgt;
            }
            final_price = accAdd(final_price, accMul(line_price,line_qty));
          });
          //减去优惠金额
          var minus = obj.parents('.order').find('.p_minus').text();
          var sum = accSub(final_price, minus);

          //加上运费
          var delivery_fee = obj.parents('.order').find('.p_drive').text();
          sum = accAdd(sum, delivery_fee);
          //减去押金
          var deposit = obj.parents('.order').find('.p_deposit').val();
          if(deposit) {
            deposit     = parseInt(deposit);
            sum  = accSub(sum,deposit);
          }

          obj.parents('.order').find('.p_final').text(sum);
          obj.parents('.order').find('.p_final').val(sum);
          //计算实收金额，累加所有的小计，并减去优惠金额
          var deal_sum = 0;
          obj.parents('.order').find('.p_sum').each(function(index,item){
            deal_sum = accAdd(deal_sum, $.trim($(item).text()));
          });
          deal_sum = accSub(deal_sum, minus);
          deal_sum = accAdd(deal_sum,delivery_fee);
          //抹零处理
          var paystatus = obj.parents('.order').find('input[name=final_price]').attr('paystatus');
          if (paystatus != '已付款') {
            deal_sum = wipeZero(deal_sum);
          }
          //减去押金
          if(deposit) {
            deal_sum  = accSub(deal_sum,deposit);
          }

      		obj.parents('.order').find('.p_deal').val(deal_sum);
      	}

        $('.p_sum').on('input',function(){
            var minus = $(this).parents('.order').find('.p_minus').text();
            //计算实收金额，累加所有的小计，并减去优惠金额
            var deal_sum = 0;
            $(this).parents('.order').find('.p_sum').each(function(index,item){
              deal_sum = accAdd(deal_sum, $(item).text());
            });
            deal_sum = accSub(deal_sum, minus);
            deal_sum = accAdd(deal_sum,delivery_fee);
            $(this).parents('.order').find('.p_deal').val(deal_sum);
        });

      //签收逻辑
      $('.btn-sign').on('click',
      function() {
        real_quantity = $(this).parents('form.order').find('input.real');
        var i = 1;
        var flag = 0;
        real_quantity.each(function() {
          real = $(this).val();
          if (real == '') {
            i = 0;
            $(this).focus();
            return false;
          } else {
            i = 1;
          }
          if (Math.ceil(real) > 0){
            flag = 1;
          }

        });
        if (i == 1 && flag) {
          var params = $(this).closest('form.order').serialize();
          var addr = "{:U('sign')}";
          var bid  =  $(this).parents('.order').find('input[name=bid]').val();
          var oid = $(this).parents('.order').find('input[name=id]').val();
          $.ajax({
            url: addr,
            type: 'post',
            cache: false,
            dataType: 'json',
            data: params,
            success: function(msg) {
              if (typeof HostApp == "undefined") {
                alert(msg.msg);
              } else {
                HostApp.toast(msg.msg);
                checkPoint(bid);
              }
              if (msg.status == '0') {
                var url = action + "/id/{$id}/oid/"+oid;
                location.href = url;
              }
            }
          });
        } else {
          alert('签收数量不能为空,不能全为0');
        }
      });
      
      //拒收逻辑
      var rejectDialog = {
        showRejectBox : function(obj) {
          var reject_box = $('#reject-box'),
              trans_bg   = $('#trans-bg');
          trans_bg.show();
          reject_box.removeClass('hidden');
          $("a[data-action='saveReason']").on("click", function(e){
            e.preventDefault();
            var selectCase = $("input[name='reason[]']:checked");
            if(selectCase.length){
              selectCase.each(function(){
                var hid = '<input name="reject_reason[]" value="'+$(this).val()+'" type="hidden">';
                obj.closest('form.order').append(hid);
              });
              trans_bg.hide();
              reject_box.addClass('hidden');
              rejectDialog.subReject(obj);
              selectCase.attr('checked',false);
              $("input[name='reject_reason[]']").remove();
            }else{
              return false;
            }
          });

          $("a[data-action='cancle']").on("click", function(e){
            e.preventDefault();
            trans_bg.hide();
            reject_box.addClass('hidden');
          });
          trans_bg.on("click", function(e){
            e.preventDefault();
            trans_bg.hide();
            reject_box.addClass('hidden');
          });
        },
        subReject : function(obj) {
          var params = obj.closest('form.order').serialize();
          var bid    = obj.parents('.order').find('input[name=bid]').val();
          var addr   = "{:U('reject')}";
          $.ajax({
            url: addr,
            type: 'post',
            cache: false,
            dataType: 'json',
            data: params,
            success: function(msg) {
              if (typeof HostApp == "undefined") {
                alert(msg.msg);
              } else {
                HostApp.toast(msg.msg);
                checkPoint(bid);
              }
              if (msg.status == '0') {
                location.reload();
              } 
              return false;
            }
          });
        }
      } 
      //拒收按钮单击事件
      $('.btn-reject').on('click',function(e) {
        e.preventDefault();
        var _this = $(this);
        var ver = _this.data('ver');
        if(ver == 1){
          rejectDialog.showRejectBox(_this);
        }else{
          rejectDialog.subReject(_this);
        }
        return false;
      });
    });
    
    $('.js-btn-print').on('click',function(){
          var printStr = $(this).data('str'),
              oid = $(this).data('id'),
              bid = $(this).data('bid'),
              pagecount = 2;
          var url = "{$signature_url}";
          oid = oid.toString();
          bid = bid.toString();
          pagecount = parseInt(pagecount);
          printStr = JSON.stringify(printStr);
          ticketPrint(printStr, oid, url, bid, pagecount);
      })

    function check(x) {
      var val = $(x).children('#show').text();
      if (val == '点击展开') {
        $(x).children('#show').text('点击收回');
      } else {
        $(x).children('#show').text('点击展开');
      }
    }

    function checkValue(x) {
      var val1 = $(x).data('val');
      var val2 = $(x).val();
      val2 = val2.replace('/[^/d/.]/g','');
      $(x).val(val2);
      if(val1 < val2){
        if (typeof HostApp == "undefined") {
          alert('输入数量不能大于下单数量，请重新输入');
        } else {
          HostApp.toast('输入数量不能大于下单数量，请重新输入');
        }
        $(x).val(val1);
      } else {
        $(x).val(val2);
      }
    }

    function checkDeposit(x) {
      var val1 = $(x).parents('.order').find('input[name=final_price]').val();
      val1 = parseInt(val1);
      var val2 = $(x).val();
      val2 = val2.replace('/[^/d/.]/g','');
      $(x).val(val2);
      val2 = parseInt(val2);
      if(val1 < 0){
        if (typeof HostApp == "undefined") {
          alert('输入的押金不能大于应收金额，请重新输入');
        } else {
          HostApp.toast('输入的押金不能大于应收金额，请重新输入');
        }
        $(x).val(0);
      } else {
        $(x).val(val2);
      }
    }

    $('.report').on('click',
      function() {
        if (confirm('确定要报错吗')) {
          var userid = $(this).data('userid');
          var type    = '定位错误';
          report = {'user_id':userid,'type':type};
          tmsReportError(report);
        }
    });

    $('.task-sign').on('click',function() {
          var id   = $(this).data('id');
          var queue= $(this).data('queue');
          var pid  = $(this).data('pid');
          var key  = $(this).data('key');
          var fKey = $('.task-sign:first').data('key');
          var lKey = $('.task-sign:last').data('key');
          var addr = "{:U('taskSign')}";
          $.ajax({
            url: addr,
            type: 'post',
            cache: false,
            dataType: 'json',
            data:{'id':id,'queue':queue,'pid':pid},
            success: function(msg) {
              if (typeof HostApp == "undefined") {
                alert(msg.msg);
                if(msg.status == 1) {
                  if(key == fKey) {
                    start(pid);
                  } else if(key == lKey) {
                    last(pid);
                  }
                  location.reload();
                }
              } else {
                HostApp.toast(msg.msg);
                if (msg.status == 1) { //任务签到成功的话收集信息
                  if(key == fKey) {
                    start(pid);
                    HostApp.collectPoint(id);
                  } else if(key == lKey) {
                    HostApp.collectPoint(id);
                    last(pid);
                  } else {
                    HostApp.collectPoint(id);
                  }
                  location.reload();
                }
              }
            }  
          });
    });

    function getPoint(str) {
      $(document).ajaxStart(function() {
      finish();
      });
      var geo = JSON.parse(str);
      if (geo.id.indexOf('A') != -1) {
        $.post("{:U('checkPoint')}",geo,function(res) {
          HostApp.toast(res.msg);
        });
      } else {
        $.post("{:U('getPoint')}",geo,function(res) {
          HostApp.toast(res.msg);
        });
      }
    }

    function last(id) {
      var id = id;
      var addr = "{:U('signFinished')}";
      $.ajax({
        url: addr,
        type: 'post',
        cache: false,
        dataType: 'json',
        data:{'id':id},
        success: function(msg) {
          if (typeof HostApp == "undefined") {
            alert(msg.msg);
          } else {
            HostApp.toast(msg.msg);
            if(msg.status == 1) {
              HostApp.stopLocate('D'+id);
            }
          } 
        }  
      });
    }

  function start(id) {
    var id = id;
    if (typeof HostApp == "undefined") {
    } else {
      HostApp.toast('开始');
      HostApp.startLocate('D'+id);
    }
  }

    //查看签到点是否正常
  function checkPoint(bid) {
    var id = 'A'+bid;
    HostApp.collectPoint(id);
  }
  </script>