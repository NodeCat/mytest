<div class="row">
<div class="col-lg-6">
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">权限列表</h3>
  </div>
  <div class="panel-body" style="padding: 0 15px;">
	<div class="row">
		<div class="toolbar">
			<a class="select-all btn btn-sm" data-target="tree" data-original-title="Refresh" rel="tooltip" data-placement="bottom">全选</a>
		    <a class="select-invert btn btn-sm" data-target="tree" data-original-title="Refresh" rel="tooltip" data-placement="bottom">反选</a>
		    <a class="select-cancel btn btn-sm" data-target="tree" data-original-title="Refresh" rel="tooltip" data-placement="bottom">取消</a>
		    <a  role="button" data-original-title="Save" rel="tooltip" data-placement="bottom" class="btn btn-sm pull-right">设置</a>
		</div>
	</div>
	<div class="row">
		<div class="well well-small">
			<ul id="tree" class="ztree"></ul>
		</div>
	</div>
  </div>
</div>
</div>

<div class="col-lg-6">
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">角色列表</h3>
  </div>
  <div class="panel-body" style="padding: 0 15px;">
	<div class="row">
		<div class="toolbar">
			<a class="select-all btn btn-sm" data-target="data-table" data-original-title="Refresh" rel="tooltip" data-placement="bottom">全选</a>
		    <a class="select-invert btn  btn-sm" data-target="data-table" data-original-title="Refresh" rel="tooltip" data-placement="bottom">反选</a>
		    <a class="select-cancel btn  btn-sm" data-target="data-table" data-original-title="Refresh" rel="tooltip" data-placement="bottom">取消</a>
		    <a  role="button" data-original-title="Save" rel="tooltip" data-placement="bottom" class="btn btn-sm pull-right">设置</a>

		</div>
	</div>
	<div class="row">
		<table id="data-table" class="table table-condensed table-bordered  table-hover">
		    <thead>
		        <tr class="align-center">
		            <th></th>
		            <th>名称</th>
		            <th>描述</th>
		        </tr>
		    </thead>
		    <tbody>
		        <volist name="roles" id="vo">
		        <tr>
		            <td><label class="checkbox"><input type="checkbox" id="{$vo['id']}" />{$row}</label></td>
		            <td>{$vo.name}</td>
		            <td>{$vo.description}</td>
		        </tr>
		        </volist>
		    </tbody>
		</table>
	</div>
  </div>
</div>
<div class="col-lg-6 text-center">
	<a onclick="getNodeValue()" role="button" data-original-title="Save" rel="tooltip" data-placement="bottom" class="btn btn-lg btn-primary">保存</a>
</div>
<div class="col-lg-6 text-center">
	<a role="button" data-original-title="Save" rel="tooltip" data-placement="bottom" class="btn btn-lg btn-default">返回</a>
</div>
</div>
</div>
<link href="__PUBLIC__/zTree/css/zTreeStyle/zTreeStyle.css" rel="stylesheet">
<style type="text/css">
	.ztree li span.button.add {margin-left:2px; margin-right: -1px; background-position:-144px 0; vertical-align:top; *vertical-align:middle}
</style>

<script type="text/javascript">
$(function(){
head.js(
	"__PUBLIC__/zTree/js/jquery.ztree.all-3.5.min.js",initTree
	);

	$("#data-table input[type='checkbox']").change(function(){
		var treeNodes;
		var id;
		if($(this).prop('checked')){
		 	id = $(this).attr('id');
			$("#data-table input:checked").each(function(){
				if($(this).attr('id')!=id)
					$(this).removeAttr('checked');
			});
		}

		var zTree = $.fn.zTree.getZTreeObj("tree");
		zTree.checkAllNodes(false);
		if(!id){
			return;
		}

		$.ajax({
		   	type: "POST",
			url:"{:U(CONTROLLER_NAME.'/role_authority')}",
		    data:{ids:id},
		    success: function (strResult) {
		       var treeNodes=eval(strResult);
		       if(!treeNodes)return;
		       var treeObj = $.fn.zTree.getZTreeObj("tree");
		  		for (var i=0 ; i<treeNodes.length; i++) {
		  			var node=treeObj.getNodeByParam("id", treeNodes[i]['id'],null);
		  			if(node)
		  				treeObj.checkNode(node, true, false);
		  		}
		    },
		    error: function () {
		        alert("Ajax请求数据失败!");
		    }
			});

	});
});
function initTree(){
	var treeNodes;
	$.ajax({
	   	type: "POST",
		url:"{:U(CONTROLLER_NAME.'/nodes')}",
		data: { type: "all"},
	    success: function (strReult) {
	       treeNodes=eval(strReult);

	var setting = {
		view: {
			selectedMulti: false,
			showLine: false,
			showIcon: true,
			expandSpeed:"",
		},
		check: {
			enable: true,
			chkStyle: "checkbox",
			autoCheckTrigger: true
		},
		data: {
			keep: {
				parent:false,
				leaf:false
			},
			simpleData: {
				enable: true,
				idKey: "id",
				pIdKey: "pid",

			}
		},
		callback: {
			beforeCheck: beforeCheck,
			onCheck: onCheck
		}
	};
	$.fn.zTree.init($("#tree"), setting, treeNodes);
	var treeObj = $.fn.zTree.getZTreeObj("tree");
	//treeObj.expandAll(false);
	$("[data-target=tree].select-invert").bind("click", {type:"checkAllTrigger"}, checkNode);
	$("[data-target=tree].select-all").bind("click", {type:"checkAllTrue"}, checkNode);
	$("[data-target=tree].select-cancel").bind("click", {type:"checkAllFalse"}, checkNode);
	//$("[data-target=tree].select-invert").bind("change", {}, setAutoTrigger);

	    }, 
	    error: function () {
	        alert("Ajax请求数据失败!");
	    }
	  });
}
var code, log, className = "dark";
function beforeCheck(treeId, treeNode) {
	className = (className === "dark" ? "":"dark");
	return (treeNode.doCheck !== false);
}
function onCheck(e, treeId, treeNode) {
}		
function showLog(str) {
	if (!log) log = $("#log");
	log.append("<li class='"+className+"'>"+str+"</li>");
	if(log.children("li").length > 6) {
		log.get(0).removeChild(log.children("li")[0]);
	}
}
function getTime() {
	var now= new Date(),
	h=now.getHours(),
	m=now.getMinutes(),
	s=now.getSeconds(),
	ms=now.getMilliseconds();
	return (h+":"+m+":"+s+ " " +ms);
}

function checkNode(e) {
	var zTree = $.fn.zTree.getZTreeObj("tree"),
	type = e.data.type,
	nodes = zTree.getSelectedNodes();
	if (type.indexOf("All")<0 && nodes.length == 0) {
		alert("请先选择一个节点");
	}

	if (type == "checkAllTrue") {
		zTree.checkAllNodes(true);
	} else if (type == "checkAllTrigger") {
		checkAllTrigger();
		//zTree.checkNode(zTree.getNodes(), null,true, callbackFlag);
	} else if (type == "checkAllFalse") {
		zTree.checkAllNodes(false);
	} else {
		var callbackFlag = $("#callbackTrigger").attr("checked");
		for (var i=0, l=nodes.length; i<l; i++) {
			if (type == "checkTrue") {
				zTree.checkNode(nodes[i], true, false, callbackFlag);
			} else if (type == "checkFalse") {
				zTree.checkNode(nodes[i], false, false, callbackFlag);
			} else if (type == "toggle") {
				zTree.checkNode(nodes[i], null, false, callbackFlag);
			}else if (type == "checkTruePS") {
				zTree.checkNode(nodes[i], true, true, callbackFlag);
			} else if (type == "checkFalsePS") {
				zTree.checkNode(nodes[i], false, true, callbackFlag);
			} else if (type == "togglePS") {
				zTree.checkNode(nodes[i], null, true, callbackFlag);
			}
		}
	}
}
function checkAllTrigger(){
	var zTree = $.fn.zTree.getZTreeObj("tree"),
	nodes = zTree.getNodes(true);
	for (var i=0, l=nodes.length; i<l; i++) {
		zTree.checkNode(nodes[i], null, true);
	}
}
function getCheckedNodes() {
	var zTree = $.fn.zTree.getZTreeObj("tree"),
	nodes = zTree.getCheckedNodes();
	for (var i=0, l=nodes.length; i<l; i++) {
		//处理
	}
	checkCount = zTree.getCheckedNodes(true).length,
	alert(checkCount);
}

function count() {
	var zTree = $.fn.zTree.getZTreeObj("tree"),
	checkCount = zTree.getCheckedNodes(true).length,
	nocheckCount = zTree.getCheckedNodes(false).length,
	changeCount = zTree.getChangeCheckedNodes().length;
}
function setAutoTrigger(e) {
	var zTree = $.fn.zTree.getZTreeObj("tree");
	zTree.setting.check.autoCheckTrigger = $("#autoCallbackTrigger").attr("checked");
	$("#autoCheckTriggerValue").html(zTree.setting.check.autoCheckTrigger ? "true" : "false");
}

function getNodeValue(){
  	var zTree = $.fn.zTree.getZTreeObj("tree");
 	var nodes = zTree.getCheckedNodes();
    var nids = new Array();  
  	for(var i=0; i<nodes.length; i++){
  		//if(!nodes[i].getCheckStatus().half)
      		nids[i]= nodes[i].id;
    }
    var aids=nids.join(',');
	var rids=getChecked();
    $.ajax({
		  type: "POST",
		  url:"{:U(CONTROLLER_NAME.'/edit')}",
		  data: {role_ids:rids, auth_ids:aids},
		  success:(function(msg) {
		  	alert(msg.msg);
		})});
}
</SCRIPT>
