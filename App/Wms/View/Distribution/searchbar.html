<notempty name="query">
<form class="form-horizontal form-ajax-only table-search" action="__SELF__" method="POST" id="table-searchbar" style="margin-bottom:0;border-bottom:none">
<div class="row">
<include file="search" />
<volist name="query" id="vo" key="k">
<eq name="k%5" value="0"></div><div class="row"></eq>
<div class="form-group  col-lg-3">
<neq name="vo['control_type']" value="checkbox">
<label class="control-label col-lg-4 col-sm-4 col-xs-4">{$vo.title}</label>
</neq>
<div class="col-lg-8 col-sm-8 col-xs-8">
     <switch name="vo['control_type']">
        <case value="null|text|area">{~$a++}
            <input type="txt" name="query[{$key}]" class="form-control input-sm">
        </case>
        <case value="date|datetime|time">{~$a++}
            {~$datetime_format=array('datetime'=>'yyyy-mm-dd hh:ii:ss','date'=>'yyyy-mm-dd','time'=>'hh:ii:ss')}
            <div class="input-group input-group-sm">
            <input type="txt" rel='datepicker' name="query[{$key}]" class="form-control input-sm form_{$vo['control_type']}" data-date-format="{$datetime_format[$vo['control_type']]}">
             <!--<span class="input-group-btn">
                <button class="btn btn-default" type="button"><i class="glyphicon glyphicon-calendar"></i></button>
              </span>-->
            </div>
            <eq name="vo['query_type']" value="between">{~$a++}
            </div></div>
            <div class="form-group  col-lg-3 ">
            <label class="control-label col-lg-4 col-sm-4 col-xs-4 " style="text-align: left;">&nbsp;&nbsp;&nbsp;&nbsp;－</label>
            <div class="col-lg-8 col-sm-8 col-xs-8">
            <div class="input-group input-group-sm">
                <input type="txt" rel='datepicker' name="query[{$key}_1]" class="form-control input-sm form_{$vo['control_type']}" data-date-format="{$datetime_format[$vo['control_type']]}">
                <!--<span class="input-group-btn">
                <button class="btn btn-default" type="button"><i class="glyphicon glyphicon-calendar"></i></button>
              </span>-->
            </div>
            </eq>
        </case>
        <case value="digit">{~$a++}
            <input type="txt" rel='datepicker' name="query[{$key}]" class="form-control input-sm">
            <eq name="vo['query_type']" value="between">
                －&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="txt" rel='datepicker' name="query[{$key}_1]" class="form-control input-sm">
            </eq>
        </case>
        <case value="checkbox" >{~$a++}
            &nbsp;&nbsp;<label class="checkbox"><input type="checkbox" name="query[{$key}]" id="query[{$key}]" />{$vo['title']} </label>&nbsp;&nbsp;
        </case>
        <case value="select">{~$a++}
            <select name="query[{$key}]" class="form-control input-sm ">
                <option value ="">全部</option>
                <volist name="vo['value']" id="op">
                    <option value ="{$key}">{$op}</option>
                </volist>
            </select>
        </case>
        <case value="refer">{~$a++}
            {~$items=explode(',',$vo['value'])}
            <div class="input-group  input-group-sm" id="{$items[0]}-query">
                <input type="text" value="" data-target="{$items[2]}" class="form-control" placeholder="" readonly="">
                <input type="hidden" value="" name="query[{$key}]" id="query[{$key}]" data-target="{$items[1]}" class="" placeholder="">
                <span class="input-group-btn">
                <a data-href="{:U(end($items),'refer='.$items[0].'-query')}" data-target="#modal-refer" data-toggle="modal" class="btn btn-default btn-"><i class="glyphicon glyphicon-search"></i></a>
                </span>
            </div>
        </case>
        <case value="getField">{~$a++}
            <php>
                $_parm=explode('.',$vo['value']);
                
                if(count($_parm)===2){
                    $A=A($_parm[0]);
                    $items=$A->get_list($_parm[0],$_parm[1]);
                }
            </php>
            <select name="query[{$key}]" class="form-control input-sm">
                <option value ="">全部</option>
                <volist name="items" id="op">
                    <option value ="{$key}">{$op}</option>
                </volist>
            </select>
        </case>
        <default/>{~$a++}
            <label class="control-label col-lg-4 col-sm-4 col-xs-4">{$vo.title}</label><input type="txt" name="query[{$key}]" class="input-sm">
    </switch>
</div>
</div>
</volist>
<div class="form-group  col-lg-6">
<div class="col-lg-10 col-lg-offset-2">
   <button type="submit" data-href="__SELF__" onclick="" id="btn-query" class="btn btn-sm btn-primary btn-tool"><span class="glyphicon glyphicon-search"></span> 查询</button>&nbsp;&nbsp;&nbsp;&nbsp;
   <a href="{:U('__ACTION__')}?"  class="btn btn-default btn-sm">显示全部</a>
   <a href="javascript:void(0)"  class="btn btn-default btn-sm" id="print-page">打印</a>
   <a href="javascript:void(0)"  class="btn btn-default btn-sm" id="export-dis">导出三联单</a>
   <a href="javascript:void(0)"  class="btn btn-default btn-sm" id="delete_dist">删除配送单</a>
   <a href="javascript:void(0)"  class="btn btn-default btn-sm" id="create_wave">创建波次</a>
</div>
</div>
   <eq name="search_addon" value="TRUE">
   <include file="search_addon" />
   </eq>
</div>
<div class="clearfix"></div>
<include file="create-wave" />
<include file="confirm-wave" />
</form>
</notempty>

<script>
var alert_dialog = {
		
		close:function(){
			this.hide();
			window.location.reload();
		},
		show:function(title, content){
			title  = title?title:'提示框';
			content = content?content:"<div class='row'>content</div>";
			$('[aria-labelledby = gridSystemModalLabeldialog]').addClass('in');
			$('[aria-labelledby = gridSystemModalLabeldialog]').show();
			$("#gridSystemModalLabelalert").html(title);
			$(".lgo").html(content);
		},
		hide:function(){
			$('[aria-labelledby = gridSystemModalLabeldialog]').removeClass('in');
			$('[aria-labelledby = gridSystemModalLabeldialog]').hide();
			$('[aria-labelledby = gridSystemModalLabeldialog]').remove();
		}
	};
	$(function() {
		$('.form-ajax-only button[type=submit]').on('click',function(){
			var addr,params;
			params=$(this).parents('form').serialize();
			addr=$(this).parents('form').attr('action');
			$.ajax({
				url:addr,
				type:'post',
				cache : false,
				async:true,
				data:params,
				success: function(msg){
			        $('.table-content').html(msg);
				},
			}); 
			return false;
		});
		 $(document).on('click','#print-page',function(){
			 var ids = getChecked();
			 /*var idArr = ids.split(',');
			 if (idArr.length > 1) {
				 alert('只能选择一个订单');
				 return false;
			 }
			 var id = idArr[0];*/
			 var url = "/Distribution/printpage?id="+ids;
			 window.open(url);
		 });
		 $(document).on('click','#export-dis',function(){
			 var ids = getChecked();
			 var idArr = ids.split(',');
			 if (idArr.length > 1) {
				 alert('只能选择一个配送单');
				 return false;
			 } else if (idArr.length <= 0) {
				 alert('请选择配送单');
				 return false;
			 }
			 var id = idArr[0];
			 var url = "/Distribution/exportdis?id="+id;
			 location.href = url;
		 });
		 /*$(document).on('click','#export-disbution',function(){
			 var ids = getChecked();
			 var url = "/Distribution/export_distribution?id="+ids;
			 location.href = url;
		 });*/
		 $(document).on('click','#delete_dist',function(){
			 var ids = getChecked();
			 var url = "/Distribution/delete_dist?id="+ids;
			 location.href = url;
		 });
		$(document).on('click','#confirm-over',function(){
			 var url = "/Distribution/index";
			 location.href = url;
		 });
		 $(document).on('click','#confirm',function(){
			 
			 var url = "/Distribution/create_wave";
			 var form_ajax = $('#form-alert-only').serialize();
			 alert_dialog.hide();
			 $.ajax({
					url:url,
					type:'get',
					cache : false,
					async:true,
					data:form_ajax,
					success: function(msg){
						if (msg.data == '') {
							alert(msg.msg);
							return false;
						}
						msg.data.title = '创建波次成功';
						var html = template('dialog_confirm', msg.data);
						$('body').append(html);
					}
				});
		 });
		 $(document).on('click','#create_wave',function(){
			 var ids = getChecked();
			 var url = "/Distribution/create_wave";
			 $.ajax({
					url:url,
					type:'get',
					cache : false,
					async:true,
					data:'id='+ids,
					success: function(msg){
						if (msg.data == '') {
							alert(msg.msg);
							return false;
						}
						if (typeof(msg.data.type) != 'undefined' && msg.data.type == 'success') {
							msg.data.title = '创建波次成功';
							var html = template('dialog_confirm', msg.data);
							$('body').append(html);
						} else {
							msg.data.title = '是否确定创建波次?';
							var html = template('dialog_create', msg.data);
							$('body').append(html);
					    }
					},
				});
		 });
		 
		
	});
</script>