<div role="tabpanel">
  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">货品</a></li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="home">
    	<table id="table-pro" class="data-table table table-bordere table-striped table-condensed table-hover" style="">
  		<thead>
  			<th>产品名称</th>
  			<th>计划加工量</th>
  			<th>操作</th>
  		</thead>
  		<tbody>
        <tr class="hidden tr-tpl">
        <td style="width:50%;">
	        <input type="hidden" value="" name="pros[pro_code][]" class="pro_code form-control input-sm" >
	        <input type="hidden" value="" name="pros[pro_name][]" class="pro_name form-control input-sm" >
	        <input type="hidden" value="" name="pros[pro_attrs][]" class="pro_attrs form-control input-sm" >
	        <input type="text" id="typeahead" placeholder="编号" class="pro_names typeahead form-control input-sm" autocomplete="off" >
	    </td>
        <td  style="width:10%;">
            <input type="text" name="pros[pro_qty][]" placeholder="数量"  value="1.00" class="form-control input-sm text-left pro_qty" autocomplete="off">
        </td>
        <td style="width:10%;" class="text-center">
            <a data-href="/Category/delete.htm" data-value="67" class="btn btn-xs btn-delete" data-title="删除" rel="tooltip" data-toggle="tooltip" data-trigger="hover" data-placement="bottom" data-original-title="" title=""><i class="glyphicon glyphicon-trash"></i> </a>
        </td>
      </tr>
  			<tr>
  				<td colspan="6"><a class="add-pro" href="#">添加一个产品</a></td>
  			</tr>
  		</tbody>
  		</table>
    </div>
  </div>
</div>

  </div>

	<div class="">
	  <textarea name="pro_infos" id="pro_infos" class="form-control" rows="5" placeholder="批量添加，请从excel中直接粘贴，数据格式：货品号 计划加工量 中间请用tab分割，每行请回车"></textarea>
	  </br>
	  <a id="preview" class="btn btn-sm btn-primary btn-tool"><span class="glyphicon"></span>批量添加预览</a>
	</div>

  <div class="row">
    <div class="tab-content">
      <textarea name="remark" class="form-control" rows="5" placeholder="备注"></textarea>
    </div>
  </div>

</div>
<style type="text/css">
#table-pro input[type=text]{
  padding: 1px 10px;
  font-size: 13px;
}

</style>
<script type="text/javascript">

$(function(){

typehead();
var i = 0;
$('.add-pro').on('click',function(){
	i++;
    var val = $('.tr-cur .pro_code').val();
    if(val == '' && val != null) {
      $('.tr-cur .pro_names').focus();
      alert('请输入产品编号选择产品。');
      return;
    }
    $('.tr-cur').removeClass('tr-cur');
    var tr = $('#table-pro tr.tr-tpl').clone();
    tr.removeClass('tr-tpl');
    tr.addClass('tr-cur');
    tr.removeClass('hidden');
    $('#table-pro tr:eq(1)').after(tr);
    typehead();
    $('#table-pro tr.tr-cur .pro_names').focus();
    $('#table-pro tr:eq(3)').find('input:not(#typeahead)').each(function() {
    		var old_name = $(this).attr('name');
    		var new_name = old_name.replace('0', i);
    		$(this).attr('name', new_name);
    });
    //$('#table-pro tr:eq(3)').find('select').attr('name', 'pros[' + i + '][pro_uom]');
});


$('#table-pro').delegate('.pro_names','focus',function(){
  $('.tr-active').removeClass('tr-active');
  $(this).parents('tr').addClass('tr-active');
});

$('#table-pro').delegate('input','click',function(){
  $(this).select();
});

});

function typehead() {
$('.tr-cur .pro_names').typeahead({ 
    display: 'name',
    val: 'val',
    items:10,
    ajax: {
      url:"{:U('Process/match_code')}",
      triggerLength: 1,
      method: 'post',
      preDispatch: function(data) {
          return { 'q': data };
      },
      preProcess: function(data) {
        var n =$.parseJSON(data);
        $.each(n,function(a,b){
          n[a]['val'] = JSON.stringify(b['val']);
        }); 
        return n;
      }
    },
    itemSelected:function(item,val,text) {
        val = $.parseJSON(val);
        $('#table-pro .tr-active .pro_code').val(val['code']);
        $('#table-pro .tr-active .pro_name').val(val['name']);
        $('#table-pro .tr-active .pro_attrs').val(val['attrs']);
        $('.tr-active').removeClass('tr-active');
    }
  	});
	//删除操作
	$('.tab-content').delegate( '.btn-delete', 'click', function(){
	  $(this).closest('tr').remove();
	});
	
	 //预览
	  $('#preview').on('click',function(){
	    var _pro_infos = $('#pro_infos').val();
	    var _url = '/Process/preview';
	    //提交数据到后端处理
	    $.ajax({
	      url:_url,
	      type:'post',
	      cache : false,
	      dataType:'json',
	      data:'pro_infos='+_pro_infos,
	      success: function(json){
	        if(json.status == 1){
	          $('#table-pro tr:last').before(json.data.html);
	          typehead();
	        }else{
	          alert(json.msg);
	        }
	      }
	    });
	  });

}

/******liuguangping*******/
var checkObj = {
  chekInput:function(){
    $(document).on('blur','#table-pro .tr-cur .pro_qty',function(){
      var out_qty = parseFloat($(this).val());
      var reg = /^[0-9]*(\.[0-9]{1,2})?$/;
      if (!reg.test(out_qty)){
        alert('计划加工量只能精确到小数点两位');
        $(this).val('1.00');
      }
      
    });
  }
};
checkObj.chekInput();
</script>

<style type="text/css">
#table-pro input[type=text]{
  padding: 0px 10px;
  font-size: 13px;
}
#table-pro input[type=text],#table-pro select{
  border: none;
  box-shadow:none;
  height: 24px;
}
</style>